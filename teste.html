<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Chamadas</title>
    <meta http-equiv="refresh" content="5">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #1b4d1b;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-top: 30px;
        }

        .titulo-principal {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #FFCC00;
            text-align: center;
        }

        .painel {
            width: 90%;
            max-width: 1900px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
            overflow: hidden;
            text-align: center;
            font-size: 1.5em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: orange;
            padding: 12px;
            text-align: center;
            color: white;
            font-size: 1.2em;
        }

        td {
            padding: 17px;
            text-align: center;
            color: white;
            vertical-align: top;
        }

        tr:nth-child(even) {
            background-color: rgba(0,100,0,0.6);
        }

        tr:nth-child(odd) {
            background-color: rgba(0,128,0,0.6);
        }

        .visto {
            background-color: rgba(128,128,128,0.6);
            color: white;
        }

        button {
            padding: 5px 10px;
            background-color: #FFCC00;
            color: #004620;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin: 2px;
        }

        button:hover {
            background-color: #FFD633;
        }

        button:disabled {
            background-color: gray !important;
            cursor: not-allowed;
        }

        .entrada {
            color: #00FF00;
            font-weight: bold;
        }

        .saida {
            color: #FF3300;
            font-weight: bold;
        }

        .status {
            font-weight: bold;
            margin-top: 5px;
            text-align: left;
        }

        .status-aceito {
            color: #00FF00;
        }

        .status-no_deposito {
            color: #FF3300;
        }

        .status-a_caminho {
            color: #FFFF00;
        }

        .status-entregue {
            color: #00FF00;
        }

        .status-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
    </style>
</head>
<body>
    <div class="titulo-principal">Painel de Chamadas {{ deposito }}</div>
    <div class="painel">
        <table>
            <thead>
                <tr>
                    <th>Operação</th>
                    <th>Depósito</th>
                    <th>Ação / Status</th>
                    <th>Horários</th>
                    <th>Chegada</th>
                </tr>
            </thead>
            <tbody>
                {% for n in notificacoes %}
                <tr class="{% if n.visto %}visto{% endif %}">
                    <td class="{% if n.nome=='Entrada' %}entrada{% elif n.nome=='Saída' %}saida{% endif %}">
                        {{ n.nome }}{% if n.setor %} - {{ n.setor }}{% endif %}
                    </td>
                    <td>{{ n.local }}</td>
                    <td>
                        {% set tipo = n.nome|lower %}
                        {% if tipo in ['carro','empilhadeira'] %}
                            {% if n.status != "entregue" %}
                                <button onclick="atualizarStatus({{ n.id }}, 'aceito', '{{ deposito }}', this)" {% if 'aceito' in n.botoes_desabilitados %}disabled{% endif %}>Aceitar</button>
                                <button onclick="atualizarStatus({{ n.id }}, 'no_deposito', '{{ deposito }}', this)" {% if 'no_deposito' in n.botoes_desabilitados %}disabled{% endif %}>Chegou no depósito</button>
                                <button onclick="atualizarStatus({{ n.id }}, 'a_caminho', '{{ deposito }}', this)" {% if 'a_caminho' in n.botoes_desabilitados %}disabled{% endif %}>Saiu p/ expedição</button>
                                <button onclick="atualizarStatus({{ n.id }}, 'entregue', '{{ deposito }}', this)" {% if 'entregue' in n.botoes_desabilitados %}disabled{% endif %}>Chegou na expedição</button>
                            {% endif %}
                        {% else %}
                            {% if n.visto %}
                                ✔ Visto
                            {% else %}
                                <button onclick="marcarComoVisto({{ n.id }}, '{{ deposito }}', this)" {% if 'visto' in n.botoes_desabilitados %}disabled{% endif %}>Marcar como visto</button>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        <div class="status-container" id="status-{{ n.id }}">
                            {% for key, hora in n.status_horarios.items() %}
                                <div class="status-{{ key }}">{{ key.replace('_',' ')|capitalize }} ({{ hora }})</div>
                            {% endfor %}
                        </div>
                    </td>
                    <td>{{ n.hora_criacao }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const audiosDepositos = {
            "D-06": "{{ url_for('static', filename='sounds/D-06.mp3') }}",
            "D-09": "{{ url_for('static', filename='sounds/D-9.mp3') }}",
            "D-13": "{{ url_for('static', filename='sounds/D-13.mp3') }}",
            "D-14": "{{ url_for('static', filename='sounds/D-14.mp3') }}",
            "CLIMATIZADA": "{{ url_for('static', filename='sounds/CLIMATIZADA.mp3') }}",
            "D-18_19": "{{ url_for('static', filename='sounds/D-18_19.mp3') }}",
            "D-24": "{{ url_for('static', filename='sounds/D-24.mp3') }}",
            "D-25": "{{ url_for('static', filename='sounds/D-25.mp3') }}",
            "HASTES": "{{ url_for('static', filename='sounds/HASTES.mp3') }}"
        };

        const audioNota = "{{ url_for('static', filename='sounds/nota.mp3') }}";
        const audioCarro = "{{ url_for('static', filename='sounds/pedido.mp3') }}";
        const audioEmpilhadeira = "{{ url_for('static', filename='sounds/pedido.mp3') }}";

        let audioAtual = null;
        let notificacoesAceitas = new Set([
            {% for n in notificacoes %}
                {% if n.visto %}{{ n.id }},{% endif %}
            {% endfor %}
        ]);

        function pararAudio(){
            if(audioAtual){
                audioAtual.pause();
                audioAtual.currentTime = 0;
            }
        }

        function tocarSom(tipo, deposito, id){
            if(!tipo) return;
            if(notificacoesAceitas.has(id)) return;

            let audioFile = null;
            if(tipo.toLowerCase() === "entrada" || tipo.toLowerCase() === "saída")
                audioFile = audiosDepositos[deposito] || audioNota;
            else if(tipo.toLowerCase() === "carro")
                audioFile = audioCarro;
            else if(tipo.toLowerCase() === "empilhadeira")
                audioFile = audioEmpilhadeira;

            if(audioFile){
                pararAudio();
                audioAtual = new Audio(audioFile);
                audioAtual.play();
            }
        }

        function atualizarStatus(id, status, deposito, botao){
            pararAudio();
            notificacoesAceitas.add(id);

            fetch(`/atualizar_status/${id}/${status}/${deposito}`, { method:'POST' })
            .then(r => r.json())
            .then(data => {
                if(data.success){
                    const linha = botao.closest('tr');
                    linha.querySelectorAll('button').forEach(b => b.disabled = true);

                    const container = document.getElementById(`status-${id}`);
                    const div = document.createElement('div');
                    div.className = `status-${status}`;
                    div.textContent = status.replace('_',' ').charAt(0).toUpperCase() + status.replace('_',' ').slice(1) + ` (${data.hora})`;
                    container.appendChild(div);
                } else {
                    alert("Erro ao atualizar status");
                }
            })
            .catch(err => { console.error(err); alert("Erro na conexão com o servidor"); });
        }

        function marcarComoVisto(id, deposito, botao){
            pararAudio();
            notificacoesAceitas.add(id);

            fetch(`/atualizar_status/${id}/visto/${deposito}`, { method:'POST' })
            .then(r => r.json())
            .then(data => {
                if(data.success){
                    botao.disabled = true;
                    botao.outerHTML='✔ Visto';
                    const linha = botao.closest('tr');
                    linha.querySelector('td:last-child').textContent = data.hora_visto;
                } else {
                    alert("Erro ao marcar como visto");
                }
            })
            .catch(err => { console.error(err); alert("Erro na conexão com o servidor"); });
        }

        window.onload = function(){
            {% for n in notificacoes %}
                {% if not n.visto %}
                    {% if n.nome.lower() in ['carro','empilhadeira'] %}
                        {% if n.status!="entregue" and n.status!="aceito" %}
                            tocarSom("{{ n.nome }}","{{ n.local }}", {{ n.id }});
                        {% endif %}
                    {% else %}
                        {% if n.local==deposito %}tocarSom("{{ n.nome }}","{{ n.local }}", {{ n.id }});{% endif %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        };
    </script>
</body>
</html>
